<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026麻將統計</title>
    
    <!-- iOS PWA 核心標籤 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="2026麻將">
    
    <!-- 自定義 App 圖示 (發財 SVG) -->
    <link rel="apple-touch-icon" id="apple-icon">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { background-color: black; color: white; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .safe-area-inset { padding-top: env(safe-area-inset-top); }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="app" class="safe-area-inset"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ---！！！請將此處替換為你自己的 Firebase Config ！！！---
        const firebaseConfig = {
            apiKey: "AIzaSyAJq5ty6AuCiooCEEAaK5rgmAsr4m6CuxY",
            authDomain: "mahjong-2026-8fc29.firebaseapp.com",
            projectId: "mahjong-2026-8fc29",
            storageBucket: "mahjong-2026-8fc29.firebasestorage.app",
            messagingSenderId: "140721320236",
            appId: "1:140721320236:web:71e3c4ee9ba293cfac7c89",
            measurementId: "G-T703SJZV5W"
        };

        // 生成發財圖示並設定為 Apple Touch Icon
        const generateIcon = () => {
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <rect width="100" height="100" rx="20" fill="black"/>
                    <text x="50" y="72" font-family="Arial" font-size="65" fill="#f97316" text-anchor="middle" font-weight="900">發</text>
                </svg>
            `;
            const base64 = btoa(svg);
            document.getElementById('apple-icon').href = `data:image/svg+xml;base64,${base64}`;
        };
        generateIcon();

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let records = {};
        let currentDate = new Date(2026, 0, 1);
        let selectedDate = null;

        async function init() {
            onAuthStateChanged(auth, async (u) => {
                if (!u) { await signInAnonymously(auth); }
                else { 
                    user = u;
                    const q = collection(db, 'records_v1', user.uid, 'days');
                    onSnapshot(q, (snapshot) => {
                        records = {};
                        snapshot.forEach(doc => { records[doc.id] = doc.data(); });
                        render();
                    });
                }
            });
        }

        window.render = function() {
            const appEl = document.getElementById('app');
            const stats = calculateStats();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthName = new Intl.DateTimeFormat('zh-TW', { month: 'long' }).format(currentDate);

            appEl.innerHTML = `
                <div class="max-w-md mx-auto p-4 pt-8">
                    <header class="mb-8 border-b border-zinc-800 pb-8">
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <h1 class="text-4xl font-black text-white"><span class="text-orange-500">2026</span> 麻將</h1>
                                <p class="text-md text-orange-500 font-black italic tracking-widest mt-1 uppercase">自摸就自摸還槓上</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-3">
                            ${statBox('贏', stats.w, 'text-green-500')}
                            ${statBox('輸', stats.l, 'text-red-500')}
                            ${statBox('台費', stats.f, 'text-zinc-500')}
                            ${statBox('淨利', stats.n, 'text-orange-500', true)}
                        </div>
                    </header>

                    <div class="bg-zinc-950 rounded-[2rem] border border-zinc-800 overflow-hidden shadow-2xl">
                        <div class="flex items-center justify-between px-6 py-5 border-b border-zinc-900 bg-zinc-900/30">
                            <span class="font-black text-lg tracking-widest text-zinc-100">${year} / ${monthName}</span>
                            <div class="flex gap-6">
                                <button onclick="changeMonth(-1)"><i data-lucide="chevron-left" class="text-zinc-500"></i></button>
                                <button onclick="changeMonth(1)"><i data-lucide="chevron-right" class="text-zinc-500"></i></button>
                            </div>
                        </div>
                        <div class="calendar-grid text-center text-[10px] font-black text-zinc-800 py-3 border-b border-zinc-900">
                            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                        </div>
                        <div class="calendar-grid">${generateCalendarDays(year, month)}</div>
                    </div>
                </div>
                ${selectedDate ? renderModal() : ''}
            `;
            lucide.createIcons();
        };

        function statBox(label, val, color, highlight = false) {
            return `
                <div class="text-center p-3 rounded-2xl bg-zinc-900 border ${highlight ? 'border-orange-500/50 shadow-lg' : 'border-zinc-800'}">
                    <p class="text-[10px] text-zinc-600 font-black uppercase mb-1">${label}</p>
                    <p class="text-xl font-black ${color} truncate tracking-tighter">${val.toLocaleString()}</p>
                </div>
            `;
        }

        function generateCalendarDays(y, m) {
            const days = [];
            const total = new Date(y, m + 1, 0).getDate();
            const offset = new Date(y, m, 1).getDay();
            for (let i = 0; i < offset; i++) days.push(`<div class="h-16 border border-zinc-900 bg-black"></div>`);
            for (let d = 1; d <= total; d++) {
                const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const r = records[dStr] || {};
                const isToday = new Date().toISOString().split('T')[0] === dStr;
                days.push(`
                    <div onclick="openModal('${dStr}')" class="h-16 border border-zinc-900 p-2 active:bg-zinc-800 transition-all relative">
                        <div class="flex justify-between">
                            <span class="text-[11px] font-bold ${isToday ? 'text-orange-500' : 'text-zinc-700'}">${d}</span>
                            ${r.memo ? '<div class="w-1 h-1 bg-orange-500 rounded-full shadow-[0_0_5px_#f97316]"></div>' : ''}
                        </div>
                        ${(r.amount || r.tableFee) ? `<div class="text-[9px] font-black mt-1 truncate ${r.amount > 0 ? 'text-green-500' : r.amount < 0 ? 'text-red-500' : 'text-zinc-500'}">${r.amount || ''}</div>` : ''}
                    </div>
                `);
            }
            return days.join('');
        }

        function calculateStats() {
            let w = 0, l = 0, f = 0;
            Object.values(records).forEach(r => {
                const amt = Number(r.amount) || 0;
                const fee = Number(r.tableFee) || 0;
                if (amt > 0) w += amt; else l += Math.abs(amt);
                f += fee;
            });
            return { w, l, f, n: w - l - f };
        }

        window.changeMonth = (dir) => { currentDate.setMonth(currentDate.getMonth() + dir); render(); };
        window.openModal = (dStr) => { selectedDate = dStr; render(); };
        window.closeModal = () => { selectedDate = null; render(); };
        window.saveData = async () => {
            const amount = document.getElementById('m_amount').value;
            const tableFee = document.getElementById('m_fee').value;
            const memo = document.getElementById('m_memo').value;
            await setDoc(doc(db, 'records_v1', user.uid, 'days', selectedDate), {
                amount: Number(amount) || 0,
                tableFee: Number(tableFee) || 0,
                memo: memo,
                updatedAt: new Date().toISOString()
            });
            closeModal();
        };

        function renderModal() {
            const r = records[selectedDate] || { amount: 0, tableFee: 0, memo: '' };
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/98 backdrop-blur-2xl">
                    <div class="bg-zinc-950 rounded-[2.5rem] w-full max-w-sm border border-zinc-800 shadow-2xl overflow-hidden p-8 animate-in zoom-in duration-200">
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h3 class="font-black text-2xl text-orange-500 tracking-widest">${selectedDate}</h3>
                                <p class="text-[10px] text-zinc-600 font-black uppercase">Mahjong Record</p>
                            </div>
                            <button onclick="closeModal()" class="text-4xl text-zinc-600 hover:text-white">&times;</button>
                        </div>
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-zinc-700 uppercase tracking-widest">贏/輸</label>
                                    <input id="m_amount" type="number" inputmode="numeric" class="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-xl font-black focus:border-orange-500/50 outline-none" value="${r.amount}">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-zinc-700 uppercase tracking-widest">台費</label>
                                    <input id="m_fee" type="number" inputmode="numeric" class="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-xl font-black focus:border-orange-500/50 outline-none" value="${r.tableFee}">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-orange-500 uppercase flex items-center gap-1 tracking-widest">記事備忘</label>
                                <textarea id="m_memo" class="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-sm h-32 focus:border-orange-500/50 outline-none resize-none">${r.memo || ''}</textarea>
                            </div>
                            <button onclick="saveData()" class="w-full bg-orange-500 text-black py-4 rounded-[1.5rem] font-black text-lg shadow-xl active:scale-95 transition-all">儲存戰報</button>
                        </div>
                    </div>
                </div>
            `;
        }
        init();
    </script>
</body>
</html>

